name: CI Build

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

permissions:
  contents: read

jobs:
  build:
    name: Build and Test
    runs-on: macos-14
    strategy:
      matrix:
        config: [debug, release]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: latest-stable

      - name: Cache Swift Build
        uses: actions/cache@v4
        with:
          path: .build
          key: ${{ runner.os }}-swift-${{ matrix.config }}-${{ hashFiles('Package.swift') }}
          restore-keys: |
            ${{ runner.os }}-swift-${{ matrix.config }}-
            ${{ runner.os }}-swift-

      - name: Swift Version
        run: swift --version

      - name: Build ${{ matrix.config }}
        run: |
          if [[ "${{ matrix.config }}" == "release" ]]; then
            swift build -c release -v
          else
            swift build -v
          fi

      - name: Check Binary
        run: |
          if [[ "${{ matrix.config }}" == "release" ]]; then
            BINARY=.build/release/ClaudeUsage
          else
            BINARY=.build/debug/ClaudeUsage
          fi

          echo "Checking binary: $BINARY"
          file "$BINARY"
          ls -lh "$BINARY"

          # Try to run (will fail without credentials, but shouldn't crash)
          "$BINARY" --help 2>&1 || echo "Expected: app requires credentials"

      - name: Run Tests
        run: swift test || echo "No tests configured yet"

      - name: Verify Code Structure
        run: |
          echo "Checking Swift files..."
          find ClaudeUsage -name "*.swift" -type f | wc -l

          echo "Checking for hardcoded secrets..."
          ! grep -r "sk-ant-" ClaudeUsage/ || (echo "Warning: Potential API key found" && exit 1)

  lint:
    name: Code Quality
    runs-on: macos-14

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: latest-stable

      - name: Check File Permissions
        run: |
          echo "Checking executable scripts..."
          ls -la scripts/

          for script in scripts/*.sh; do
            if [[ -x "$script" ]]; then
              echo "✓ $script is executable"
            else
              echo "✗ $script is not executable"
              exit 1
            fi
          done

      - name: Validate Package.swift
        run: swift package describe

      - name: Check Swift Format (if available)
        run: |
          if command -v swift-format &> /dev/null; then
            swift-format lint -r ClaudeUsage/
          else
            echo "swift-format not available, skipping"
          fi

  bundle-test:
    name: Test App Bundle Creation
    runs-on: macos-14
    needs: build

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: latest-stable

      - name: Build Release
        run: swift build -c release

      - name: Make Scripts Executable
        run: chmod +x scripts/*.sh

      - name: Test Icon Creation
        run: |
          ./scripts/create-icns.sh
          test -f build/AppIcon.icns
          ls -lh build/AppIcon.icns

      - name: Test App Bundle Creation
        run: |
          ./scripts/create-app-bundle.sh
          test -d build/ClaudeUsage.app
          test -f build/ClaudeUsage.app/Contents/MacOS/ClaudeUsage
          test -f build/ClaudeUsage.app/Contents/Resources/AppIcon.icns
          test -f build/ClaudeUsage.app/Contents/Info.plist

      - name: Verify Info.plist
        run: plutil -lint build/ClaudeUsage.app/Contents/Info.plist

      - name: Test DMG Creation
        run: |
          ./scripts/create-dmg.sh
          test -f build/ClaudeUsage.dmg
          ls -lh build/ClaudeUsage.dmg

      - name: Upload Test Artifacts
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: test-build-artifacts
          path: |
            build/ClaudeUsage.app
            build/*.icns
          retention-days: 7
