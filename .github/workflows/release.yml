name: Release

on:
  push:
    tags: ['v*']

permissions:
  contents: write

jobs:
  release:
    runs-on: macos-14
    steps:
      - uses: actions/checkout@v4

      - name: Build
        run: |
          swift build -c release --arch arm64
          mkdir -p .build/release-arm64 && cp .build/release/ClaudeUsage .build/release-arm64/
          swift build -c release --arch x86_64
          mkdir -p .build/release-intel && cp .build/release/ClaudeUsage .build/release-intel/

      - name: Package
        run: |
          chmod +x scripts/*.sh
          ./scripts/create-icns.sh
          ./scripts/create-app-bundle-arch.sh arm64
          ./scripts/create-app-bundle-arch.sh intel
          ./scripts/create-dmg-arch.sh arm64
          ./scripts/create-dmg-arch.sh intel

      - name: Checksums
        run: |
          cd build-arm64 && shasum -a 256 *.dmg *.zip > checksums-arm64.txt && cd ..
          cd build-intel && shasum -a 256 *.dmg *.zip > checksums-intel.txt && cd ..

      - name: Release
        uses: softprops/action-gh-release@v2
        with:
          files: |
            build-arm64/ClaudeUsage-arm64.dmg
            build-arm64/ClaudeUsage-arm64.app.zip
            build-arm64/checksums-arm64.txt
            build-intel/ClaudeUsage-intel.dmg
            build-intel/ClaudeUsage-intel.app.zip
            build-intel/checksums-intel.txt
          body: |
            ## Download

            **Apple Silicon (M1/M2/M3/M4):** `ClaudeUsage-arm64.dmg`
            **Intel:** `ClaudeUsage-intel.dmg`

            Not sure? Click  → About This Mac → look for "Chip" or "Processor"
          generate_release_notes: true
